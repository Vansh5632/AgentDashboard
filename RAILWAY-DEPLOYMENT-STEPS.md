# ðŸš„ Railway Deployment Guide - Step by Step

## Prerequisites âœ…

Before starting, ensure you have:
- Railway account (sign up at [railway.app](https://railway.app))
- Git repository pushed to GitHub/GitLab
- All required API keys (OpenAI, Pinecone, ElevenLabs, etc.)

---

## Step 1: Install Railway CLI

```bash
# Install Railway CLI
npm install -g @railway/cli

# Or using curl
curl -fsSL https://railway.app/install.sh | sh

# Login to Railway
railway login
```

---

## Step 2: Create New Railway Project

### Option A: Using CLI
```bash
# Navigate to your project directory
cd /home/vansh5632/Freelancing/ai_agent

# Create new Railway project
railway new
# Enter project name: "ai-agent-platform"
```

### Option B: Using Web Dashboard
1. Go to [railway.app](https://railway.app)
2. Click "New Project"
3. Choose "Deploy from GitHub repo"
4. Select your `AgentDashboard` repository

---

## Step 3: Add Required Services

### 3.1 Add PostgreSQL Database
```bash
# Add PostgreSQL service
railway add --service postgresql

# Or via web dashboard:
# 1. Click "Add Service" â†’ "Database" â†’ "PostgreSQL"
```

### 3.2 Add Redis Database
```bash
# Add Redis service
railway add --service redis

# Or via web dashboard:
# 1. Click "Add Service" â†’ "Database" â†’ "Redis"
```

---

## Step 4: Configure Environment Variables

### 4.1 Set Variables via CLI
```bash
# Set database URL (Railway will provide this automatically)
railway variables set DATABASE_URL="postgresql://..." 

# Set Redis connection
railway variables set REDIS_HOST="redis-host-from-railway"
railway variables set REDIS_PORT="6379"

# Set security variables
railway variables set JWT_SECRET="your-super-secure-jwt-secret-change-this"

# Set external API keys
railway variables set OPENAI_API_KEY="sk-proj-your-openai-key"
railway variables set PINECONE_API_KEY="pcsk_your-pinecone-key"
railway variables set PINECONE_INDEX_NAME="agent-memory"
railway variables set ELEVENLABS_API_KEY="sk_your-elevenlabs-key"
railway variables set CALCOM_API_BASE_URL="https://api.cal.com/v1"

# Optional services
railway variables set GHL_API_KEY="your-ghl-key"
railway variables set N8N_WEBHOOK_URL="your-n8n-webhook"
```

### 4.2 Set Variables via Web Dashboard
1. Go to your project dashboard
2. Click on each service â†’ "Variables" tab
3. Add the environment variables listed above

### ðŸ“‹ **REQUIRED ENVIRONMENT VARIABLES CHECKLIST:**

**Database & Infrastructure:**
- âœ… `DATABASE_URL` - Auto-generated by Railway PostgreSQL
- âœ… `REDIS_HOST` - Auto-generated by Railway Redis
- âœ… `REDIS_PORT` - Usually 6379

**Security:**
- âœ… `JWT_SECRET` - Generate a strong secret key

**External APIs (YOU MUST PROVIDE):**
- âœ… `OPENAI_API_KEY` - Your OpenAI API key
- âœ… `PINECONE_API_KEY` - Your Pinecone API key
- âœ… `PINECONE_INDEX_NAME` - Your Pinecone index name
- âœ… `ELEVENLABS_API_KEY` - Your ElevenLabs API key
- âœ… `CALCOM_API_BASE_URL` - Usually https://api.cal.com/v1

**Optional:**
- âšª `GHL_API_KEY` - GoHighLevel integration
- âšª `N8N_WEBHOOK_URL` - N8N automation webhook

---

## Step 5: Configure Service Deployment

### 5.1 Create railway.json (Optional)
```bash
# Create railway.json in project root
cat > railway.json << 'EOF'
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "DOCKERFILE",
    "dockerfilePath": "apps/api/Dockerfile"
  },
  "deploy": {
    "startCommand": "node dist/server.js",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
EOF
```

### 5.2 Service Configuration

**For API Service:**
- Build Context: Root directory (`/`)
- Dockerfile Path: `apps/api/Dockerfile`
- Port: `3001`
- Health Check: `/health`

**For Worker Service:**
- Build Context: Root directory (`/`)
- Dockerfile Path: `apps/worker/Dockerfile`
- No port exposure needed
- Health Check: Process check

**For Web Service:**
- Build Context: Root directory (`/`)
- Dockerfile Path: `apps/web/Dockerfile`
- Port: `3000`
- Health Check: `/api/health`

---

## Step 6: Deploy Services

### 6.1 Deploy via CLI
```bash
# Deploy all services
railway up

# Or deploy specific service
railway up --service api
railway up --service worker
railway up --service web
```

### 6.2 Deploy via Git Push
```bash
# If connected to GitHub
git add .
git commit -m "Deploy to Railway"
git push origin main

# Railway will automatically deploy on push
```

---

## Step 7: Run Database Migrations

### 7.1 Access API Service Terminal
```bash
# Connect to API service
railway shell

# Or via web dashboard: Service â†’ "Shell" tab
```

### 7.2 Run Migrations
```bash
# Inside the API container
./migrate.sh

# Or manually:
npx prisma migrate deploy --schema=./schema.prisma
```

---

## Step 8: Verify Deployment

### 8.1 Check Service Status
```bash
# View deployment status
railway status

# View logs
railway logs
railway logs --service api
railway logs --service worker
railway logs --service web
```

### 8.2 Test Health Endpoints
```bash
# Get your Railway URLs
railway domains

# Test API health
curl https://your-api-url.railway.app/health

# Test Web health
curl https://your-web-url.railway.app/api/health
```

### 8.3 Verify Database Connection
```bash
# Connect to API service
railway shell

# Test database connection
node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.$connect().then(() => console.log('DB Connected!')).catch(console.error);"
```

---

## Step 9: Configure Custom Domains (Optional)

### 9.1 Add Custom Domain
```bash
# Add custom domain
railway domain add yourdomain.com

# Or via web dashboard: Service â†’ "Domains" tab
```

### 9.2 Configure DNS
1. Add CNAME record: `yourdomain.com` â†’ `your-app.railway.app`
2. Railway will automatically provision SSL certificate

---

## Step 10: Monitor and Scale

### 10.1 Monitor Logs
```bash
# Real-time logs
railway logs --follow

# Service-specific logs
railway logs --service worker --follow
```

### 10.2 Scale Services
```bash
# Scale via CLI
railway scale --replicas 2

# Or via web dashboard: Service â†’ "Settings" â†’ "Scale"
```

---

## ðŸš¨ Troubleshooting Common Issues

### Issue 1: Build Failures
**Symptoms:** Services fail to build
**Solutions:**
```bash
# Check build logs
railway logs --build

# Verify Dockerfile paths
# Ensure pnpm-lock.yaml is committed
# Check package.json syntax
```

### Issue 2: Database Connection Errors
**Symptoms:** `DATABASE_URL` connection failed
**Solutions:**
```bash
# Verify DATABASE_URL format
railway variables get DATABASE_URL

# Check if PostgreSQL service is running
railway status

# Restart PostgreSQL service if needed
railway restart --service postgresql
```

### Issue 3: Environment Variables Not Set
**Symptoms:** Missing API keys or configuration
**Solutions:**
```bash
# List all variables
railway variables

# Add missing variables
railway variables set OPENAI_API_KEY="your-key"

# Restart services after adding variables
railway restart
```

### Issue 4: Health Check Failures
**Symptoms:** Services marked as unhealthy
**Solutions:**
```bash
# Check if ports are correct
# API should be on port 3001
# Web should be on port 3000

# Verify health check endpoints
curl https://your-api-url.railway.app/health
```

### Issue 5: Worker Not Processing Jobs
**Symptoms:** Background jobs not executing
**Solutions:**
```bash
# Check Redis connection
railway logs --service worker

# Verify Redis service is running
railway status

# Check BullMQ configuration in worker logs
```

---

## ðŸ“Š Post-Deployment Checklist

### âœ… Services Running
- [ ] PostgreSQL database is healthy
- [ ] Redis database is healthy  
- [ ] API service is responding on `/health`
- [ ] Worker service is processing jobs
- [ ] Web service is accessible and responding

### âœ… Security Verified
- [ ] No hardcoded secrets in code
- [ ] All environment variables properly set
- [ ] SSL certificates active (https://)
- [ ] Database access restricted to services

### âœ… Functionality Working
- [ ] User registration/login works
- [ ] API endpoints responding correctly
- [ ] Background jobs processing
- [ ] Database queries executing
- [ ] External API integrations working

---

## ðŸŽ‰ Success! Your AI Agent Platform is Live

Once all steps are completed, your platform will be accessible at:
- **Web App:** `https://your-web-app.railway.app`
- **API:** `https://your-api-app.railway.app`

### Next Steps:
1. **Test all functionality** thoroughly
2. **Set up monitoring** and alerts
3. **Configure backup strategies**
4. **Document your Railway URLs** for your team
5. **Set up CI/CD** for automatic deployments

---

## ðŸ†˜ Need Help?

- **Railway Documentation:** [docs.railway.app](https://docs.railway.app)
- **Railway Discord:** [discord.gg/railway](https://discord.gg/railway)
- **Railway Support:** [help.railway.app](https://help.railway.app)

Your deployment is now production-ready! ðŸš€